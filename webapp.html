<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StoriesWall</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —è –∏—Ö —É–±—Ä–∞–ª –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ */
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }
        body { font-family: 'Inter', sans-serif; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); margin: 0; padding: 0; }
        .container { max-width: 100%; padding: 16px; padding-bottom: 80px; }
        .header { text-align: center; margin-bottom: 24px; padding-top: 8px; }
        .header h1 { font-size: 24px; font-weight: 700; }
        .header p { font-size: 14px; color: var(--tg-theme-hint-color); }
        .presets { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
        .preset-btn { background: var(--tg-theme-secondary-bg-color); border: 2px solid transparent; border-radius: 12px; padding: 12px 8px; cursor: pointer; transition: all 0.2s; position: relative; text-align: center;}
        .preset-btn.active { border-color: var(--tg-theme-button-color); }
        .preset-preview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; margin-bottom: 8px; }
        .preset-preview div { padding-top: 124.26%; background: var(--tg-theme-hint-color); opacity: 0.3; border-radius: 2px; }
        .preset-btn.active .preset-preview div { background: var(--tg-theme-button-color); opacity: 1; }
        .preset-label { font-size: 13px; font-weight: 600; color: var(--tg-theme-text-color); }
        .fit-selector { background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 8px; margin-bottom: 16px; }
        .fit-option { display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 8px; }
        .fit-option.active { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
        .fit-option input { margin-right: 12px; }
        .upload-area { border: 2px dashed var(--tg-theme-hint-color); border-radius: 16px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 16px; background: var(--tg-theme-secondary-bg-color); }
        .upload-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-text { font-size: 15px; color: var(--tg-theme-hint-color); font-weight: 500; }
        .image-preview { width: 100%; border-radius: 12px; margin-bottom: 16px; display: none; }
        .image-preview.visible { display: block; }
        .image-preview img { width: 100%; border-radius: 12px; }
        .preview-grid { display: grid; gap: 4px; padding: 8px; background: var(--tg-theme-secondary-bg-color); border-radius: 12px; margin-bottom: 16px; }
        .preview-grid.hidden { display: none; }
        .preview-cell { position: relative; padding-top: 124.26%; background: var(--tg-theme-bg-color); border-radius: 4px; overflow: hidden; }
        .preview-cell img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .status { text-align: center; font-size: 14px; color: var(--tg-theme-hint-color); margin: 16px 0; min-height: 20px; }
        input[type="file"] { display: none; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.visible { display: block; }
        .spinner { border: 3px solid var(--tg-theme-secondary-bg-color); border-top: 3px solid var(--tg-theme-button-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® StoriesWall</h1>
            <p>–°–æ–∑–¥–∞–π –∏–¥–µ–∞–ª—å–Ω—É—é —Å—Ç–µ–Ω–∫—É –¥–ª—è —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è</p>
        </div>

        <div class="presets">
            <button class="preset-btn" data-rows="1">
                <div class="preset-preview" style="grid-template-rows: repeat(1, 1fr);"><div></div><div></div><div></div></div>
                <div class="preset-label">3 —á–∞—Å—Ç–∏</div>
            </button>
            <button class="preset-btn" data-rows="2">
                <div class="preset-preview" style="grid-template-rows: repeat(2, 1fr);"><div></div><div></div><div></div><div></div><div></div><div></div></div>
                <div class="preset-label">6 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn active" data-rows="3">
                <div class="preset-preview" style="grid-template-rows: repeat(3, 1fr);"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                <div class="preset-label">9 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn" data-rows="4">
                <div class="preset-preview" style="grid-template-rows: repeat(4, 1fr); gap: 1.5px;"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                <div class="preset-label">12 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn" data-rows="5">
                 <div class="preset-preview" style="grid-template-rows: repeat(5, 1fr); gap: 1px;"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                <div class="preset-label">15 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn" data-rows="6">
                <div class="preset-preview" style="grid-template-rows: repeat(6, 1fr); gap: 1px;"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                <div class="preset-label">18 —á–∞—Å—Ç–µ–π</div>
            </button>
             <button class="preset-btn" data-rows="7">
                <div class="preset-preview" style="grid-template-rows: repeat(7, 1fr); gap: 0.8px;"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                <div class="preset-label">21 —á–∞—Å—Ç—å</div>
            </button>
        </div>

        <div class="fit-selector">
            <div class="fit-option active" data-fit="cover">
                <input type="radio" name="fit" value="cover" checked>
                <span>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ (–æ–±—Ä–µ–∑–∞—Ç—å)</span>
            </div>
            <div class="fit-option" data-fit="contain">
                <input type="radio" name="fit" value="contain">
                <span>–í–ø–∏—Å–∞—Ç—å (–±–µ–∑ –æ–±—Ä–µ–∑–∫–∏)</span>
            </div>
        </div>

        <label for="imageLoader" class="upload-area" id="uploadArea">
            <div class="upload-icon">üì§</div>
            <div class="upload-text">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
        </label>
        <input type="file" id="imageLoader" accept="image/*">

        <div class="image-preview" id="imagePreview">
            <img id="previewImage" src="" alt="Preview">
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>–ì–æ—Ç–æ–≤–ª—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä...</div>
        </div>
        
        <div class="preview-grid hidden" id="previewGrid"></div>
        <div class="status" id="status">–í—ã–±–µ—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É');
        tg.MainButton.hide();

        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f4f4f5');

        let originalImage = null;
        let originalFile = null;
        let currentGrid = { rows: 3, cols: 3 };
        let fitStyle = 'cover';

        const imageLoader = document.getElementById('imageLoader');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const previewGrid = document.getElementById('previewGrid');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentGrid.rows = parseInt(btn.dataset.rows);
                if (originalImage) generatePreview(originalImage);
            });
        });

        document.querySelectorAll('.fit-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.fit-option').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                fitStyle = opt.dataset.fit;
                opt.querySelector('input').checked = true;
                if (originalImage) generatePreview(originalImage);
            });
        });

        imageLoader.addEventListener('change', (e) => handleFile(e.target.files[0]));
        uploadArea.addEventListener('click', () => imageLoader.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); e.target.style.opacity = 0.5; });
        uploadArea.addEventListener('dragleave', (e) => e.target.style.opacity = 1);
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.target.style.opacity = 1;
            handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            originalFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    previewImage.src = event.target.result;
                    imagePreview.classList.add('visible');
                    generatePreview(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function generatePreview(img) {
            status.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...';
            loading.classList.add('visible');
            previewGrid.classList.add('hidden');
            previewGrid.innerHTML = '';
            tg.MainButton.hide();

            await new Promise(resolve => setTimeout(resolve, 50)); // –î–∞–µ–º UI –æ–±–Ω–æ–≤–∏—Ç—å—Å—è

            const PIECE_ASPECT = 1080 / 1342;
            const GRID_COLS = currentGrid.cols;
            const GRID_ROWS = currentGrid.rows;

            const totalContentWidth = GRID_COLS;
            const totalContentHeight = GRID_ROWS * (1/PIECE_ASPECT);

            const sourceCanvas = document.createElement('canvas');
            const sourceCtx = sourceCanvas.getContext('2d');
            sourceCanvas.width = img.width;
            sourceCanvas.height = img.height;
            sourceCtx.drawImage(img, 0, 0);

            previewGrid.style.gridTemplateColumns = `repeat(${GRID_COLS}, 1fr)`;
            
            for (let row = 0; row < GRID_ROWS; row++) {
                for (let col = 0; col < GRID_COLS; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'preview-cell';
                    const previewImg = document.createElement('img');
                    
                    // –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é, –ª–æ–≥–∏–∫–∞ –æ–±—Ä–µ–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±—É–¥–µ—Ç —Ç–æ—á–Ω–µ–µ
                    const sx = (img.width / GRID_COLS) * col;
                    const sy = (img.height / GRID_ROWS) * row;
                    const sWidth = img.width / GRID_COLS;
                    const sHeight = img.height / GRID_ROWS;
                    
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = sWidth;
                    tempCanvas.height = sHeight;
                    tempCanvas.getContext('2d').drawImage(sourceCanvas, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);
                    previewImg.src = tempCanvas.toDataURL();
                    
                    cell.appendChild(previewImg);
                    previewGrid.appendChild(cell);
                }
            }
            
            loading.classList.remove('visible');
            previewGrid.classList.remove('hidden');
            status.textContent = `–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–ª—è ${GRID_ROWS * GRID_COLS} —á–∞—Å—Ç–µ–π`;
            
            tg.MainButton.setText(`–°–æ–∑–¥–∞—Ç—å (${GRID_ROWS * GRID_COLS} —á–∞—Å—Ç–µ–π)`);
            tg.MainButton.show();
        }

        tg.MainButton.onClick(() => {
            if (!originalFile) {
                tg.showAlert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
                return;
            }

            tg.MainButton.showProgress();
            status.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞...';

            const reader = new FileReader();
            reader.onload = (event) => {
                const data = {
                    action: "create_wall",
                    image_b64: event.target.result, // base64 data URL
                    parts: currentGrid.rows * currentGrid.cols,
                    fit: fitStyle
                };
                
                try {
                    tg.sendData(JSON.stringify(data));
                    // –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–∫—Ä—ã—Ç—å Web App –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    // –∏–ª–∏ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –µ–≥–æ –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.
                    // tg.close();
                } catch (error) {
                    tg.showAlert(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error}`);
                    tg.MainButton.hideProgress();
                }
            };
            reader.onerror = () => {
                tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.');
                tg.MainButton.hideProgress();
            }
            reader.readAsDataURL(originalFile);
        });
    </script>
</body>
</html>
