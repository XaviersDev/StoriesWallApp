<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StoriesWall</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-top: 8px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            line-height: 1.4;
        }

        .presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .preset-btn {
            background: var(--tg-theme-secondary-bg-color);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .preset-btn.active {
            border-color: var(--tg-theme-button-color);
            background: var(--tg-theme-button-color);
        }

        .preset-btn.active .preset-label {
            color: var(--tg-theme-button-text-color);
        }

        .preset-btn.locked::after {
            content: 'üîí';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 12px;
        }

        .preset-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            margin-bottom: 8px;
        }

        .preset-preview div {
            padding-top: 124.26%;
            background: var(--tg-theme-hint-color);
            border-radius: 2px;
            opacity: 0.3;
        }

        .preset-btn.active .preset-preview div {
            background: var(--tg-theme-button-text-color);
            opacity: 1;
        }

        .preset-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--tg-theme-text-color);
        }

        .upload-area {
            border: 2px dashed var(--tg-theme-hint-color);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
            background: var(--tg-theme-secondary-bg-color);
        }

        .upload-area.dragover {
            border-color: var(--tg-theme-button-color);
            background: var(--tg-theme-button-color);
            opacity: 0.1;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-text {
            font-size: 15px;
            color: var(--tg-theme-hint-color);
            font-weight: 500;
        }

        .image-preview {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 16px;
            display: none;
        }

        .image-preview.visible {
            display: block;
        }

        .image-preview img {
            width: 100%;
            border-radius: 12px;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            padding: 8px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .preview-grid.hidden {
            display: none;
        }

        .preview-cell {
            position: relative;
            padding-top: 124.26%;
            background: var(--tg-theme-bg-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .preview-cell img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-number {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status {
            text-align: center;
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin: 16px 0;
            min-height: 20px;
        }

        .fit-selector {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .fit-option {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .fit-option:last-child {
            margin-bottom: 0;
        }

        .fit-option.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .fit-option input {
            margin-right: 12px;
        }

        .price-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 16px;
            display: none;
        }

        .price-info.visible {
            display: block;
        }

        .price-info .price {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .price-info .label {
            font-size: 14px;
            opacity: 0.9;
        }

        input[type="file"] {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.visible {
            display: block;
        }

        .spinner {
            border: 3px solid var(--tg-theme-secondary-bg-color);
            border-top: 3px solid var(--tg-theme-button-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® StoriesWall</h1>
            <p>–°–æ–∑–¥–∞–π –∏–¥–µ–∞–ª—å–Ω—É—é —Å—Ç–µ–Ω–∫—É –¥–ª—è —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è</p>
        </div>

        <div class="presets">
            <button class="preset-btn" data-rows="1">
                <div class="preset-preview" style="grid-template-rows: repeat(1, 1fr);">
                    <div></div><div></div><div></div>
                </div>
                <div class="preset-label">3 —á–∞—Å—Ç–∏</div>
            </button>
            <button class="preset-btn" data-rows="2">
                <div class="preset-preview" style="grid-template-rows: repeat(2, 1fr);">
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                </div>
                <div class="preset-label">6 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn active" data-rows="3">
                <div class="preset-preview" style="grid-template-rows: repeat(3, 1fr);">
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                </div>
                <div class="preset-label">9 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn" data-rows="4">
                <div class="preset-preview" style="grid-template-rows: repeat(4, 1fr); gap: 1.5px;">
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                </div>
                <div class="preset-label">12 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn" data-rows="5">
                <div class="preset-preview" style="grid-template-rows: repeat(5, 1fr); gap: 1px;">
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                </div>
                <div class="preset-label">15 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn" data-rows="6">
                <div class="preset-preview" style="grid-template-rows: repeat(6, 1fr); gap: 1px;">
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                </div>
                <div class="preset-label">18 —á–∞—Å—Ç–µ–π</div>
            </button>
            <button class="preset-btn locked" data-rows="7" data-premium="true">
                <div class="preset-preview" style="grid-template-rows: repeat(7, 1fr); gap: 0.8px;">
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                    <div></div><div></div><div></div>
                </div>
                <div class="preset-label">21 —á–∞—Å—Ç—å</div>
            </button>
        </div>

        <div class="fit-selector">
            <div class="fit-option active" data-fit="cover">
                <input type="radio" name="fit" value="cover" checked>
                <span>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ (–æ–±—Ä–µ–∑–∞—Ç—å –∫—Ä–∞—è)</span>
            </div>
            <div class="fit-option" data-fit="contain">
                <input type="radio" name="fit" value="contain">
                <span>–í–ø–∏—Å–∞—Ç—å (–±–µ–∑ –æ–±—Ä–µ–∑–∫–∏)</span>
            </div>
        </div>

        <div class="price-info" id="priceInfo">
            <div class="price" id="priceAmount">0 ‚≠êÔ∏è</div>
            <div class="label" id="priceLabel">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ!</div>
        </div>

        <label for="imageLoader" class="upload-area" id="uploadArea">
            <div class="upload-icon">üì§</div>
            <div class="upload-text">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
            <div class="upload-text" style="font-size: 12px; margin-top: 8px;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∑–∞–≥—Ä—É–∂–∞—Ç—å –±–µ–∑ —Å–∂–∞—Ç–∏—è</div>
        </label>
        <input type="file" id="imageLoader" accept="image/*">

        <div class="image-preview" id="imagePreview">
            <img id="previewImage" src="" alt="Preview">
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</div>
        </div>

        <div class="preview-grid hidden" id="previewGrid"></div>

        <div class="status" id="status">–í—ã–±–µ—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText('–°–æ–∑–¥–∞—Ç—å —Å—Ç–µ–Ω–∫—É');
        tg.MainButton.hide();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f4f4f5');

        let originalImage = null;
        let generatedBlobs = [];
        let currentGrid = { rows: 3, cols: 3 };
        let fitStyle = 'cover';
        let userCreationCount = 0;

        const imageLoader = document.getElementById('imageLoader');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const previewGrid = document.getElementById('previewGrid');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const priceInfo = document.getElementById('priceInfo');
        const priceAmount = document.getElementById('priceAmount');
        const priceLabel = document.getElementById('priceLabel');

        // Preset buttons
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const isPremium = btn.dataset.premium === 'true';
                const rows = parseInt(btn.dataset.rows);
                
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentGrid.rows = rows;
                
                updatePrice();
                if (originalImage) processImage(originalImage);
            });
        });

        // Fit selector
        document.querySelectorAll('.fit-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.fit-option').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                fitStyle = opt.dataset.fit;
                opt.querySelector('input').checked = true;
                if (originalImage) processImage(originalImage);
            });
        });

        // Upload handlers
        imageLoader.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('click', () => imageLoader.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) loadImage(file);
        }

        function loadImage(file) {
            status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
            const reader = new FileReader();
            
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    previewImage.src = event.target.result;
                    imagePreview.classList.add('visible');
                    processImage(img);
                };
                img.onerror = () => {
                    status.textContent = '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª';
                    tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
                };
                img.src = event.target.result;
            };
            
            reader.readAsDataURL(file);
        }

        function updatePrice() {
            const parts = currentGrid.rows * currentGrid.cols;
            const isPremium = parts === 21;
            const needsPayment = userCreationCount >= 2;
            
            let totalPrice = 0;
            let label = '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ!';
            
            if (needsPayment) {
                totalPrice += 10;
                label = '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ';
            }
            
            if (isPremium) {
                totalPrice += 15;
                label = needsPayment ? '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ + —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ' : '–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–µ–Ω–∫–∞';
            }
            
            if (totalPrice > 0) {
                priceAmount.textContent = `${totalPrice} ‚≠êÔ∏è`;
                priceLabel.textContent = label;
                priceInfo.classList.add('visible');
            } else {
                priceInfo.classList.remove('visible');
            }
            
            if (userCreationCount === 0) {
                priceLabel.textContent = 'üéÅ –ü–µ—Ä–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!';
            } else if (userCreationCount === 1) {
                priceLabel.textContent = 'üéÅ –í—Ç–æ—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!';
            }
        }

        async function processImage(img) {
            status.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
            loading.classList.add('visible');
            previewGrid.classList.add('hidden');
            previewGrid.innerHTML = '';
            generatedBlobs = [];
            tg.MainButton.hide();

            await new Promise(resolve => setTimeout(resolve, 100));

            const TARGET_WIDTH = 1080;
            const TARGET_HEIGHT = 1920;
            const PIECE_WIDTH = 1080;
            const PIECE_HEIGHT = 1342;
            
            const GRID_COLS = currentGrid.cols;
            const GRID_ROWS = currentGrid.rows;
            const totalContentWidth = PIECE_WIDTH * GRID_COLS;
            const totalContentHeight = PIECE_HEIGHT * GRID_ROWS;

            const sourceCanvas = document.createElement('canvas');
            sourceCanvas.width = totalContentWidth;
            sourceCanvas.height = totalContentHeight;
            const sourceCtx = sourceCanvas.getContext('2d');

            const imgAspect = img.width / img.height;
            const contentAspect = totalContentWidth / totalContentHeight;
            let drawWidth, drawHeight, offsetX, offsetY;

            if (fitStyle === 'cover') {
                if (imgAspect > contentAspect) {
                    drawHeight = totalContentHeight;
                    drawWidth = drawHeight * imgAspect;
                    offsetX = (totalContentWidth - drawWidth) / 2;
                    offsetY = 0;
                } else {
                    drawWidth = totalContentWidth;
                    drawHeight = drawWidth / imgAspect;
                    offsetX = 0;
                    offsetY = (totalContentHeight - drawHeight) / 2;
                }
            } else {
                if (imgAspect > contentAspect) {
                    drawWidth = totalContentWidth;
                    drawHeight = drawWidth / imgAspect;
                    offsetX = 0;
                    offsetY = (totalContentHeight - drawHeight) / 2;
                } else {
                    drawHeight = totalContentHeight;
                    drawWidth = drawHeight * imgAspect;
                    offsetX = (totalContentWidth - drawWidth) / 2;
                    offsetY = 0;
                }
                sourceCtx.fillStyle = '#000000';
                sourceCtx.fillRect(0, 0, totalContentWidth, totalContentHeight);
            }

            sourceCtx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);

            previewGrid.style.gridTemplateColumns = `repeat(${GRID_COLS}, 1fr)`;

            for (let row = 0; row < GRID_ROWS; row++) {
                for (let col = 0; col < GRID_COLS; col++) {
                    const sx = col * PIECE_WIDTH;
                    const sy = row * PIECE_HEIGHT;

                    const outputCanvas = document.createElement('canvas');
                    outputCanvas.width = TARGET_WIDTH;
                    outputCanvas.height = TARGET_HEIGHT;
                    const outputCtx = outputCanvas.getContext('2d');
                    outputCtx.fillStyle = '#000000';
                    outputCtx.fillRect(0, 0, TARGET_WIDTH, TARGET_HEIGHT);

                    const dx = (TARGET_WIDTH - PIECE_WIDTH) / 2;
                    const dy = (TARGET_HEIGHT - PIECE_HEIGHT) / 2;
                    outputCtx.drawImage(sourceCanvas, sx, sy, PIECE_WIDTH, PIECE_HEIGHT, dx, dy, PIECE_WIDTH, PIECE_HEIGHT);

                    const previewCanvas = document.createElement('canvas');
                    previewCanvas.width = PIECE_WIDTH;
                    previewCanvas.height = PIECE_HEIGHT;
                    previewCanvas.getContext('2d').drawImage(sourceCanvas, sx, sy, PIECE_WIDTH, PIECE_HEIGHT, 0, 0, PIECE_WIDTH, PIECE_HEIGHT);

                    const previewImg = document.createElement('img');
                    previewImg.src = previewCanvas.toDataURL();
                    
                    const cell = document.createElement('div');
                    cell.className = 'preview-cell';
                    
                    const number = document.createElement('div');
                    number.className = 'preview-number';
                    number.textContent = (row * GRID_COLS + col + 1);
                    
                    cell.appendChild(previewImg);
                    cell.appendChild(number);
                    previewGrid.appendChild(cell);

                    await new Promise(resolve => {
                        outputCanvas.toBlob(blob => {
                            const imgNumber = row * GRID_COLS + col + 1;
                            generatedBlobs.push({
                                name: `story_${String(imgNumber).padStart(2, '0')}.png`,
                                blob: blob
                            });
                            resolve();
                        }, 'image/png');
                    });
                }
            }

            loading.classList.remove('visible');
            previewGrid.classList.remove('hidden');
            status.textContent = `‚úÖ –ì–æ—Ç–æ–≤–æ! ${GRID_ROWS * GRID_COLS} —á–∞—Å—Ç–µ–π —Å–æ–∑–¥–∞–Ω–æ`;
            
            tg.MainButton.setText(`–°–æ–∑–¥–∞—Ç—å —Å—Ç–µ–Ω–∫—É (${GRID_ROWS * GRID_COLS} —á–∞—Å—Ç–µ–π)`);
            tg.MainButton.show();
            tg.MainButton.enable();
        }

        tg.MainButton.onClick(async () => {
            if (generatedBlobs.length === 0) return;

            const parts = currentGrid.rows * currentGrid.cols;
            const isPremium = parts === 21;
            const needsPayment = userCreationCount >= 2;
            
            let totalPrice = 0;
            if (needsPayment) totalPrice += 10;
            if (isPremium) totalPrice += 15;

            if (totalPrice > 0) {
                tg.sendData(JSON.stringify({
                    action: 'request_payment',
                    parts: parts,
                    price: totalPrice
                }));
                return;
            }

            await downloadZip();
        });

        async function downloadZip() {
            tg.MainButton.showProgress();
            status.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';

            const zip = new JSZip();
            generatedBlobs.sort((a, b) => a.name.localeCompare(b.name));
            generatedBlobs.forEach(file => zip.file(file.name, file.blob));

            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const link = document.createElement('a');
            link.href = url;
            link.download = `storieswall_${currentGrid.cols}x${currentGrid.rows}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            tg.MainButton.hideProgress();
            status.textContent = 'üéâ –ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!';
            
            userCreationCount++;
            updatePrice();

            tg.sendData(JSON.stringify({
                action: 'creation_complete',
                parts: currentGrid.rows * currentGrid.cols
            }));

            setTimeout(() => {
                tg.showAlert('–ù–µ –∑–∞–±—É–¥—å –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ç–æ—Ä–∏—Å –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ! üì≤');
            }, 500);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updatePrice();
    </script>
</body>
</html>
