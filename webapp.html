<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StoriesWall Preview</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 8px;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .header p {
            font-size: 13px;
            color: var(--tg-theme-hint-color);
            line-height: 1.4;
        }

        .upload-area {
            border: 2px dashed var(--tg-theme-hint-color);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 16px;
            background: var(--tg-theme-secondary-bg-color);
        }

        .upload-area.dragover {
            border-color: var(--tg-theme-button-color);
            background-color: rgba(36, 129, 204, 0.1);
        }

        .upload-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-text { font-size: 14px; color: var(--tg-theme-hint-color); font-weight: 500; }
        .image-preview { width: 100%; border-radius: 12px; margin-bottom: 16px; display: none; }
        .image-preview.visible { display: block; }
        .image-preview img { width: 100%; border-radius: 12px; }

        .options-container {
            display: none;
        }
        .options-container.visible {
            display: block;
        }
        
        .options-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--tg-theme-hint-color);
            text-transform: uppercase;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .options-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .option-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            border: 2px solid var(--tg-theme-secondary-bg-color);
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-hint-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-btn.active {
            border-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-color);
            background: transparent;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            padding: 8px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .preview-grid.hidden { display: none; }
        .preview-cell {
            position: relative;
            padding-top: 124.26%;
            background: var(--tg-theme-bg-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .preview-cell img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-number {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status { text-align: center; font-size: 14px; color: var(--tg-theme-hint-color); margin: 16px 0; min-height: 20px; }
        input[type="file"] { display: none; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.visible { display: block; }
        .spinner {
            border: 3px solid var(--tg-theme-secondary-bg-color);
            border-top: 3px solid var(--tg-theme-button-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-box { background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 12px; margin-bottom: 16px; font-size: 13px; line-height: 1.5; }
        .info-box.hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–µ–Ω–∫–∏</h1>
            <p>–ó–∞–≥—Ä—É–∑–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –≤—ã–±–µ—Ä–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
        </div>

        <div class="info-box" id="infoBox">
            ‚ÑπÔ∏è –≠—Ç–æ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä! –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–µ–Ω–∫–∏ –≤–µ—Ä–Ω–∏—Å—å –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å –∫–∞—Ä—Ç–∏–Ω–∫—É —Ç–∞–º.
        </div>

        <label for="imageLoader" class="upload-area" id="uploadArea">
            <div class="upload-icon">üñº</div>
            <div class="upload-text">–ù–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
        </label>
        <input type="file" id="imageLoader" accept="image/*">

        <div class="image-preview" id="imagePreview">
            <img id="previewImage" src="" alt="Preview">
        </div>
        
        <div class="options-container" id="optionsContainer">
            <div class="options-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–µ–π</div>
            <div class="options-group" id="partsGroup">
                <button class="option-btn" data-parts="3">3</button>
                <button class="option-btn" data-parts="6">6</button>
                <button class="option-btn active" data-parts="9">9</button>
                <button class="option-btn" data-parts="12">12</button>
                <button class="option-btn" data-parts="15">15</button>
                <button class="option-btn" data-parts="18">18</button>
                <button class="option-btn" data-parts="21">21</button>
                <button class="option-btn" data-parts="25">25</button>
                <button class="option-btn" data-parts="28">28</button>
            </div>
            
            <div class="options-label">–†–µ–∂–∏–º</div>
            <div class="options-group" id="modeGroup">
                <button class="option-btn active" data-mode="cover">‚úÇÔ∏è –û–±—Ä–µ–∑–∞—Ç—å</button>
                <button class="option-btn" data-mode="contain">üñº –í–ø–∏—Å–∞—Ç—å</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>–°–æ–∑–¥–∞—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä...</div>
        </div>

        <div class="preview-grid hidden" id="previewGrid"></div>

        <div class="status" id="status">–í—ã–±–µ—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        
        tg.ready();
        tg.expand();
        tg.BackButton.show();
        
        tg.BackButton.onClick(() => tg.close());

        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f4f4f5');

        let originalImage = null;

        const imageLoader = document.getElementById('imageLoader');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const optionsContainer = document.getElementById('optionsContainer');
        const partsGroup = document.getElementById('partsGroup');
        const modeGroup = document.getElementById('modeGroup');
        const previewGrid = document.getElementById('previewGrid');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const infoBox = document.getElementById('infoBox');

        imageLoader.addEventListener('change', handleFileSelect);
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });
        
        partsGroup.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                partsGroup.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                if (originalImage) updatePreview();
            }
        });
        
        modeGroup.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                modeGroup.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                if (originalImage) updatePreview();
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        }

        function loadImage(file) {
            status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
            const reader = new FileReader();
            
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    previewImage.src = event.target.result;
                    imagePreview.classList.add('visible');
                    optionsContainer.classList.add('visible');
                    infoBox.classList.add('hidden');
                    updatePreview();
                };
                img.onerror = () => {
                    status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞';
                    tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
                };
                img.src = event.target.result;
            };
            
            reader.readAsDataURL(file);
        }

        async function updatePreview() {
            if (!originalImage) return;
            
            status.textContent = '–°–æ–∑–¥–∞—é –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä...';
            loading.classList.add('visible');
            previewGrid.classList.add('hidden');
            previewGrid.innerHTML = '';

            await new Promise(resolve => setTimeout(resolve, 50));

            const PIECE_WIDTH = 1080;
            const PIECE_HEIGHT = 1342;
            const GRID_COLS = 3;
            
            const parts = parseInt(partsGroup.querySelector('.active').dataset.parts, 10);
            const fitMode = modeGroup.querySelector('.active').dataset.mode;
            const GRID_ROWS = Math.ceil(parts / GRID_COLS); // –ò–ó–ú–ï–ù–ï–ù–û: –û–∫—Ä—É–≥–ª—è–µ–º –≤–≤–µ—Ä—Ö –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞ —Ä—è–¥–æ–≤
            
            const totalContentWidth = PIECE_WIDTH * GRID_COLS;
            const totalContentHeight = PIECE_HEIGHT * GRID_ROWS;

            const sourceCanvas = document.createElement('canvas');
            sourceCanvas.width = totalContentWidth;
            sourceCanvas.height = totalContentHeight;
            const sourceCtx = sourceCanvas.getContext('2d');

            const imgAspect = originalImage.width / originalImage.height;
            const contentAspect = totalContentWidth / totalContentHeight;
            let drawWidth, drawHeight, offsetX, offsetY;
            
            if (fitMode === 'cover') {
                if (imgAspect > contentAspect) {
                    drawHeight = totalContentHeight; drawWidth = drawHeight * imgAspect;
                    offsetX = (totalContentWidth - drawWidth) / 2; offsetY = 0;
                } else {
                    drawWidth = totalContentWidth; drawHeight = drawWidth / imgAspect;
                    offsetX = 0; offsetY = (totalContentHeight - drawHeight) / 2;
                }
            } else {
                if (imgAspect > contentAspect) {
                    drawWidth = totalContentWidth; drawHeight = drawWidth / imgAspect;
                    offsetX = 0; offsetY = (totalContentHeight - drawHeight) / 2;
                } else {
                    drawHeight = totalContentHeight; drawWidth = drawHeight * imgAspect;
                    offsetX = (totalContentWidth - drawWidth) / 2; offsetY = 0;
                }
            }

            sourceCtx.drawImage(originalImage, offsetX, offsetY, drawWidth, drawHeight);

            previewGrid.style.gridTemplateRows = `repeat(${GRID_ROWS}, 1fr)`;

            // –ò–ó–ú–ï–ù–ï–ù–û: –¶–∏–∫–ª –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–æ–≤–Ω–æ `parts` —á–∞—Å—Ç–µ–π
            for (let i = 0; i < parts; i++) {
                const row = Math.floor(i / GRID_COLS);
                const col = i % GRID_COLS;
                
                const sx = col * PIECE_WIDTH;
                const sy = row * PIECE_HEIGHT;

                const previewCanvas = document.createElement('canvas');
                previewCanvas.width = PIECE_WIDTH;
                previewCanvas.height = PIECE_HEIGHT;
                previewCanvas.getContext('2d').drawImage(
                    sourceCanvas, sx, sy, PIECE_WIDTH, PIECE_HEIGHT,
                    0, 0, PIECE_WIDTH, PIECE_HEIGHT
                );

                const previewImg = document.createElement('img');
                previewImg.src = previewCanvas.toDataURL('image/jpeg', 0.8);
                
                const cell = document.createElement('div');
                cell.className = 'preview-cell';
                
                const number = document.createElement('div');
                number.className = 'preview-number';
                number.textContent = i + 1;
                
                cell.appendChild(previewImg);
                cell.appendChild(number);
                previewGrid.appendChild(cell);
            }

            loading.classList.remove('visible');
            previewGrid.classList.remove('hidden');
            status.textContent = `‚úÖ –í–æ—Ç —Ç–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–≤–æ—è —Å–µ—Ç–∫–∞ –∏–∑ ${parts} —á–∞—Å—Ç–µ–π!`;
        }
    </script>
</body>
</html>
